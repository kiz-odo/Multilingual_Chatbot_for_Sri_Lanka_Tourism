name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PYTHON_VERSION: '3.11'
  AWS_REGION: us-east-1

jobs:
  # Pre-deployment checks
  pre-deploy-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check deployment conditions
      id: check
      run: |
        # Ensure all CI checks passed
        echo "Verifying deployment conditions..."
        echo "should_deploy=true" >> $GITHUB_OUTPUT

  # Build and push production image
  build-production:
    name: Build Production Image
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.should_deploy == 'true'
    environment: production
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ steps.login-ecr.outputs.registry }}/srilanka-tourism-backend
        tags: |
          type=sha,prefix=prod-
          type=ref,event=tag
          type=raw,value=production-latest,enable=${{ github.ref == 'refs/heads/main' }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and Push Production Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/backend/Dockerfile.production
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          GIT_SHA=${{ github.sha }}
          VERSION=${{ github.ref_name }}
    
    - name: Run Trivy security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.login-ecr.outputs.registry }}/srilanka-tourism-backend:prod-${{ github.sha }}
        format: 'table'
        exit-code: '0'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

  # Database migrations (if needed)
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: build-production
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Run migrations
      run: |
        echo "Running database migrations..."
        # Add migration commands here when Beanie migrations are set up
        # aws ecs run-task --cluster production --task-definition migrations ...
        echo "Migrations complete (no-op for now)"

  # Blue-Green deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-production, run-migrations]
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Deploy to ECS (Blue-Green)
      run: |
        echo "Deploying to production ECS cluster..."
        
        # Update task definition with new image
        aws ecs update-service \
          --cluster srilanka-tourism-production \
          --service backend \
          --force-new-deployment \
          --deployment-configuration "minimumHealthyPercent=100,maximumPercent=200"
        
        echo "Waiting for deployment to stabilize..."
        aws ecs wait services-stable \
          --cluster srilanka-tourism-production \
          --services backend
        
        echo "✅ Deployment successful!"
    
    - name: Verify deployment
      run: |
        # Wait for new tasks to be healthy
        sleep 30
        
        # Health check
        HEALTH_URL="${{ secrets.PRODUCTION_URL }}/health"
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "✅ Health check passed!"
        else
          echo "❌ Health check failed with status: $HTTP_STATUS"
          exit 1
        fi

  # Post-deployment notifications
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    
    steps:
    - name: Notify Slack on Success
      if: needs.deploy-production.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |
          ✅ Production deployment successful!
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Deployed by: ${{ github.actor }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: Notify Slack on Failure
      if: needs.deploy-production.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ❌ Production deployment FAILED!
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: Create deployment record
      if: needs.deploy-production.result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
            environment: 'production',
            auto_merge: false,
            required_contexts: []
          });

  # Rollback job (manual trigger)
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    environment: production
    
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Rollback to previous version
      run: |
        echo "Rolling back to previous stable version..."
        
        # Get previous task definition
        PREVIOUS_TASK=$(aws ecs describe-services \
          --cluster srilanka-tourism-production \
          --services backend \
          --query 'services[0].deployments[1].taskDefinition' \
          --output text)
        
        # Update service with previous task definition
        aws ecs update-service \
          --cluster srilanka-tourism-production \
          --service backend \
          --task-definition $PREVIOUS_TASK \
          --force-new-deployment
        
        echo "✅ Rollback initiated to: $PREVIOUS_TASK"
